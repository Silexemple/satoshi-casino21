<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SATS JACK 21 - Tables Multiplayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #0a0a0a;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh; height: 100dvh;
            color: #fff;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* ========== TOP BAR (toujours visible) ========== */
        .topbar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 12px;
            background: linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.7));
            border-bottom: 1px solid rgba(255,107,0,0.3);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .topbar-left { display: flex; align-items: center; gap: 10px; }
        .topbar-brand {
            font-family: 'Orbitron'; font-size: 14px; font-weight: 900;
            background: linear-gradient(135deg, #ff6b00, #ffa500);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .topbar-nick {
            font-family: 'Orbitron'; font-size: 9px; color: #888;
            cursor: pointer; letter-spacing: 1px;
        }
        .topbar-nick:hover { color: #ffa500; }
        .topbar-balance {
            font-family: 'Orbitron'; font-size: 16px; font-weight: 700;
            color: #ffa500; text-shadow: 0 0 8px rgba(255,165,0,0.4);
        }
        .topbar-balance .sat-icon { font-size: 10px; color: #ff6b00; margin-right: 2px; }
        .topbar-back {
            background: none; border: 1px solid #ff6b00; color: #ff6b00;
            padding: 4px 10px; border-radius: 4px; font-family: 'Orbitron';
            cursor: pointer; font-size: 9px; letter-spacing: 1px;
        }
        .topbar-back:hover { background: rgba(255,107,0,0.2); }

        .conn-dot {
            width: 6px; height: 6px; border-radius: 50%; display: inline-block;
        }
        .conn-dot.ok { background: #0f0; box-shadow: 0 0 6px #0f0; }
        .conn-dot.error { background: #f00; box-shadow: 0 0 6px #f00; animation: blink 1s infinite; }
        @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ========== LOBBY ========== */
        .lobby {
            padding: 50px 15px 15px;
            height: 100vh; height: 100dvh;
            overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;
            align-content: start;
        }
        .lobby.hidden { display: none; }

        .table-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(20,15,5,0.9));
            border: 2px solid #ff6b00; border-radius: 12px; padding: 20px;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .table-card:hover { transform: translateY(-3px); box-shadow: 0 0 30px rgba(255,107,0,0.4); border-color: #ffa500; }
        .table-card h3 { font-family: 'Orbitron'; color: #ffa500; font-size: 16px; margin-bottom: 8px; }
        .table-info { color: #888; font-size: 13px; margin: 3px 0; }
        .table-players { display: flex; justify-content: center; gap: 5px; margin: 8px 0; }
        .player-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid #ff6b00; }
        .player-dot.occupied { background: #ff6b00; box-shadow: 0 0 8px #ff6b00; }
        .player-dot.empty { background: transparent; opacity: 0.3; }
        .table-status {
            font-family: 'Orbitron'; font-size: 10px; margin-top: 8px; padding: 3px 12px;
            border-radius: 12px; display: inline-block; letter-spacing: 1px;
        }
        .status-waiting { background: rgba(0,255,0,0.12); color: #0f0; border: 1px solid rgba(0,255,0,0.3); }
        .status-playing { background: rgba(255,107,0,0.12); color: #ff6b00; border: 1px solid rgba(255,107,0,0.3); }
        .status-betting { background: rgba(255,215,0,0.12); color: #ffd700; border: 1px solid rgba(255,215,0,0.3); }

        /* ========== TABLE VIEW - Layout en forme de table ========== */
        .table-view { display: none; }
        .table-view.active {
            display: flex; flex-direction: column;
            height: 100vh; height: 100dvh;
            padding-top: 38px;
        }

        .felt {
            flex: 1; position: relative;
            background: radial-gradient(ellipse at 50% 30%, #1a4d1a, #0d2e0d 60%, #081a08);
            border: 3px solid #2a1500;
            border-radius: 0 0 50% 50% / 0 0 20% 20%;
            margin: 4px 4px 0;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.5), 0 0 20px rgba(255,107,0,0.15);
            overflow: hidden;
            display: flex; flex-direction: column;
        }
        .felt::before {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 3px, rgba(0,80,0,0.03) 3px, rgba(0,80,0,0.03) 6px);
            pointer-events: none;
        }

        /* DEALER ZONE - haut du feutre */
        .dealer-zone {
            text-align: center; padding: 10px 10px 5px; position: relative; z-index: 2;
            flex-shrink: 0;
        }
        .dealer-label {
            font-family: 'Orbitron'; color: rgba(255,215,0,0.6); font-size: 10px;
            letter-spacing: 4px; margin-bottom: 4px;
        }
        .dealer-cards { display: flex; justify-content: center; gap: 5px; min-height: 62px; }
        .dealer-score-badge {
            display: inline-block; background: rgba(0,0,0,0.6); color: #ffd700;
            padding: 2px 10px; border-radius: 10px; font-family: 'Orbitron';
            font-size: 13px; border: 1px solid rgba(255,215,0,0.4); margin-top: 4px;
        }
        .dealer-score-badge.bust { color: #ff4444; border-color: #ff4444; }

        /* PHASE + TIMER au centre */
        .center-info {
            text-align: center; padding: 3px 0; position: relative; z-index: 2;
            flex-shrink: 0;
        }
        .phase-text {
            font-family: 'Orbitron'; font-size: 12px; color: #ffd700;
            letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,215,0,0.3);
        }
        .timer-row {
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 3px;
        }
        .timer-bar-mini {
            width: 120px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;
        }
        .timer-fill-mini {
            height: 100%; background: linear-gradient(90deg, #ff6b00, #ffa500);
            border-radius: 2px; transition: width 1s linear;
        }
        .timer-fill-mini.low { background: #ff0000; }
        .timer-text-mini {
            font-family: 'Orbitron'; font-size: 11px; color: #ff6b00; min-width: 24px;
        }

        /* SEATS - disposés en arc en bas du feutre */
        .seats-arc {
            flex: 1; display: flex; justify-content: center; align-items: flex-end;
            gap: 6px; padding: 5px 8px 8px; position: relative; z-index: 2;
            min-height: 0;
        }

        .seat {
            flex: 1; max-width: 180px; min-width: 0;
            background: rgba(0,0,0,0.35); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px; padding: 6px 4px; text-align: center;
            transition: all 0.3s; position: relative;
            display: flex; flex-direction: column; align-items: center;
            max-height: 100%;
            overflow: hidden;
        }
        .seat.active-turn {
            border-color: #ffa500; box-shadow: 0 0 20px rgba(255,165,0,0.4);
            animation: turnGlow 1.5s ease-in-out infinite;
        }
        @keyframes turnGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(255,165,0,0.3); }
            50% { box-shadow: 0 0 30px rgba(255,165,0,0.6); }
        }
        .seat.is-me { border-color: rgba(0,255,0,0.4); background: rgba(0,255,0,0.03); }
        .seat.is-me.active-turn { border-color: #ffa500; }
        .seat.empty-seat {
            border-style: dashed; border-color: rgba(255,255,255,0.08); opacity: 0.5;
            cursor: pointer; justify-content: center;
        }
        .seat.empty-seat:hover { opacity: 0.9; border-color: #ff6b00; }

        .seat-name {
            font-family: 'Orbitron'; font-size: 9px; color: #ffa500;
            letter-spacing: 1px; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; width: 100%;
        }
        .seat-bet-badge {
            font-size: 10px; color: #888; margin: 1px 0;
        }
        .seat-cards { display: flex; justify-content: center; gap: 2px; flex-wrap: nowrap; margin: 2px 0; }

        /* Cartes */
        .card {
            width: 38px; height: 54px; background: linear-gradient(135deg, #fff, #f0f0f0);
            border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            animation: dealIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(0,0,0,0.15); flex-shrink: 0;
        }
        .dealer-cards .card { width: 48px; height: 68px; }
        @keyframes dealIn {
            0% { transform: translateY(-80px) scale(0.5); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        .card-content {
            padding: 2px 3px; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between;
            color: #000; line-height: 1;
        }
        .dealer-cards .card-content { padding: 4px 5px; }
        .corner { font-size: 9px; font-weight: bold; }
        .dealer-cards .corner { font-size: 12px; }
        .center { font-size: 18px; text-align: center; }
        .dealer-cards .center { font-size: 26px; }
        .red { color: #d00; }
        .black { color: #111; }

        .card.hidden-card {
            background: linear-gradient(135deg, #1a0800, #000); border: 1.5px solid #ff6b00;
            position: relative;
        }
        .card.hidden-card::after {
            content: "\20BF"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 22px; color: #ff6b00; font-family: 'Orbitron';
            text-shadow: 0 0 8px #ff6b00;
        }
        .dealer-cards .card.hidden-card::after { font-size: 30px; }

        .mini-score {
            display: inline-block; background: rgba(0,0,0,0.6); color: #ffa500;
            padding: 1px 6px; border-radius: 8px; font-family: 'Orbitron';
            font-size: 10px; border: 1px solid rgba(255,165,0,0.3); margin-top: 2px;
        }
        .mini-score.bust { color: #ff4444; border-color: #ff4444; }

        .seat-result {
            font-family: 'Orbitron'; font-size: 10px; font-weight: bold; margin-top: 2px;
        }
        .result-win { color: #00ff00; text-shadow: 0 0 8px rgba(0,255,0,0.5); }
        .result-loss { color: #ff4444; }
        .result-push { color: #ffa500; }
        .result-bj { color: #ffd700; text-shadow: 0 0 8px rgba(255,215,0,0.5); }
        .result-bust { color: #ff4444; }
        .result-surrender { color: #ff8800; }

        .seat-gain {
            font-family: 'Orbitron'; font-size: 11px; font-weight: bold; margin-top: 1px;
        }

        /* ========== BOTTOM PANEL - Controles + chat ========== */
        .bottom-panel {
            flex-shrink: 0; padding: 6px 8px 8px;
            background: linear-gradient(0deg, rgba(0,0,0,0.95), rgba(0,0,0,0.8));
            border-top: 1px solid rgba(255,107,0,0.2);
            position: relative; z-index: 10;
        }

        .controls-row {
            display: flex; justify-content: center; align-items: center;
            gap: 6px; flex-wrap: wrap; min-height: 44px;
        }

        /* Boutons compacts */
        .act-btn {
            padding: 8px 14px; border-radius: 6px; font-weight: bold;
            font-size: 11px; font-family: 'Orbitron'; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s; border: 2px solid; color: #000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        .act-btn:disabled { opacity: 0.25; cursor: not-allowed; transform: none !important; }
        .act-btn:hover:not(:disabled) { transform: translateY(-2px); }

        .act-hit { background: linear-gradient(135deg, #00dd00, #00aa00); border-color: #00ff00; }
        .act-stand { background: linear-gradient(135deg, #dd0000, #aa0000); border-color: #ff0000; color: #fff; }
        .act-double { background: linear-gradient(135deg, #8844cc, #6633aa); border-color: #aa66ee; color: #fff; }
        .act-split { background: linear-gradient(135deg, #dd7700, #bb5500); border-color: #ff9900; color: #fff; }
        .act-insurance { background: linear-gradient(135deg, #0088dd, #0066aa); border-color: #00aaff; color: #fff; }
        .act-surrender { background: linear-gradient(135deg, #666, #444); border-color: #888; color: #fff; }
        .act-bet { background: linear-gradient(135deg, #ff6b00, #ffa500); border-color: #ffd700; }
        .act-rebet { background: linear-gradient(135deg, #ffd700, #ff8c00); border-color: #ffd700; }
        .act-leave { background: none; border: 1px solid #ff4444; color: #ff4444; padding: 6px 10px; font-size: 9px; }

        /* Chips compacts */
        .chips-row { display: flex; justify-content: center; gap: 8px; margin: 4px 0; }
        .chip {
            width: 44px; height: 44px; border-radius: 50%; border: 3px solid;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; color: #fff; font-size: 11px;
            font-family: 'Orbitron'; transition: all 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }
        .chip:hover:not(.disabled) { transform: translateY(-4px) scale(1.1); }
        .chip.disabled { opacity: 0.25; cursor: not-allowed; filter: grayscale(1); }
        .chip.c100 { background: radial-gradient(circle, #0088ff, #0044cc); border-color: #00ccff; }
        .chip.c500 { background: radial-gradient(circle, #ff0088, #cc0044); border-color: #ff44cc; }
        .chip.c1k { background: radial-gradient(circle, #ff6b00, #cc5500); border-color: #ffd700; }
        .chip.c5k { background: radial-gradient(circle, #8800ff, #5500cc); border-color: #cc88ff; }

        .bet-amount {
            font-family: 'Orbitron'; font-size: 20px; font-weight: 900;
            color: #ffa500; text-align: center; text-shadow: 0 0 8px rgba(255,165,0,0.4);
        }

        .info-text { color: #888; font-size: 12px; text-align: center; }
        .phase-highlight {
            font-family: 'Orbitron'; font-size: 12px; color: #ffa500;
            text-align: center; letter-spacing: 2px;
        }

        /* Chat drawer */
        .chat-toggle {
            position: fixed; bottom: 8px; right: 8px; z-index: 60;
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,107,0,0.2); border: 1px solid #ff6b00;
            color: #ff6b00; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .chat-toggle:hover { background: rgba(255,107,0,0.4); }
        .chat-drawer {
            position: fixed; bottom: 50px; right: 8px; z-index: 55;
            width: 260px; max-height: 200px; background: rgba(0,0,0,0.95);
            border: 1px solid rgba(255,107,0,0.3); border-radius: 10px;
            display: none; flex-direction: column; overflow: hidden;
        }
        .chat-drawer.open { display: flex; }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 8px;
            scrollbar-width: thin; scrollbar-color: #ff6b00 transparent;
            max-height: 140px;
        }
        .chat-msg { font-size: 12px; padding: 2px 0; color: #aaa; }
        .chat-msg .name { color: #ff6b00; font-weight: bold; }
        .chat-msg .system { color: #ffd700; font-style: italic; }
        .quick-chat {
            display: flex; gap: 4px; flex-wrap: wrap; padding: 6px;
            border-top: 1px solid rgba(255,107,0,0.15); justify-content: center;
        }
        .quick-msg {
            background: rgba(255,107,0,0.1); border: 1px solid rgba(255,107,0,0.25);
            color: #ff6b00; padding: 3px 8px; border-radius: 10px; cursor: pointer;
            font-size: 10px; transition: all 0.2s;
        }
        .quick-msg:hover { background: rgba(255,107,0,0.3); }

        /* TOAST */
        .toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0);
            z-index: 1000; font-family: 'Orbitron'; font-size: 22px; font-weight: 900;
            padding: 15px 30px; border-radius: 12px; text-align: center;
            opacity: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .toast.win { background: rgba(0,0,0,0.9); border: 2px solid #00ff00; color: #00ff00; box-shadow: 0 0 40px rgba(0,255,0,0.4); }
        .toast.loss { background: rgba(0,0,0,0.9); border: 2px solid #ff0000; color: #ff0000; box-shadow: 0 0 40px rgba(255,0,0,0.3); }
        .toast.bj { background: rgba(0,0,0,0.9); border: 2px solid #ffd700; color: #ffd700; box-shadow: 0 0 40px rgba(255,215,0,0.5); }
        .toast.push { background: rgba(0,0,0,0.9); border: 2px solid #ffa500; color: #ffa500; box-shadow: 0 0 30px rgba(255,165,0,0.3); }

        @media (max-width: 400px) {
            .card { width: 32px; height: 46px; }
            .corner { font-size: 8px; }
            .center { font-size: 15px; }
            .dealer-cards .card { width: 42px; height: 60px; }
            .dealer-cards .corner { font-size: 10px; }
            .dealer-cards .center { font-size: 22px; }
            .seat { padding: 4px 2px; }
            .seat-name { font-size: 8px; }
            .act-btn { padding: 6px 10px; font-size: 9px; }
            .chip { width: 38px; height: 38px; font-size: 10px; }
        }
    </style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="topbar-left">
        <a href="/" class="topbar-back" id="backBtn">SOLO</a>
        <span class="topbar-brand">SATS<span style="color:#ffd700;">21</span></span>
        <span class="conn-dot ok" id="connDot"></span>
        <span class="topbar-nick" id="nicknameDisplay" onclick="showNicknamePrompt()"></span>
    </div>
    <div class="topbar-balance" id="balance"><span class="sat-icon">&#8383;</span>0</div>
</div>

<div class="toast" id="toast"></div>

<!-- LOBBY -->
<div class="lobby" id="lobby"></div>

<!-- TABLE VIEW -->
<div class="table-view" id="tableView">
    <!-- Feutre vert = la table -->
    <div class="felt">
        <!-- Dealer en haut -->
        <div class="dealer-zone">
            <div class="dealer-label">DEALER</div>
            <div class="dealer-cards" id="dealerCards"></div>
            <div id="dealerScore"></div>
        </div>

        <!-- Phase + Timer -->
        <div class="center-info">
            <div class="phase-text" id="phaseLabel">EN ATTENTE</div>
            <div class="timer-row" id="timerRow" style="display:none;">
                <div class="timer-bar-mini"><div class="timer-fill-mini" id="timerFill"></div></div>
                <span class="timer-text-mini" id="timerText"></span>
            </div>
        </div>

        <!-- Sièges en arc -->
        <div class="seats-arc" id="seatsGrid"></div>
    </div>

    <!-- Controles en bas (toujours visible) -->
    <div class="bottom-panel">
        <div class="controls-row" id="controls"></div>
    </div>
</div>

<!-- Chat drawer -->
<div class="chat-toggle" id="chatToggle" onclick="toggleChat()" style="display:none;">&#128172;</div>
<div class="chat-drawer" id="chatDrawer">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="quick-chat">
        <span class="quick-msg" onclick="sendChat('GL!')">GL!</span>
        <span class="quick-msg" onclick="sendChat('Nice!')">Nice!</span>
        <span class="quick-msg" onclick="sendChat('Ouch')">Ouch</span>
        <span class="quick-msg" onclick="sendChat('BJ!')">BJ!</span>
        <span class="quick-msg" onclick="sendChat('GG')">GG</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
// ============================================
// STATE
// ============================================
let balance = 0;
let currentTableId = null;
let currentBet = 0;
let lastBet = 0;
let pollInterval = null;
let lastTableState = null;
let previousStatus = null;
let chatMessages = [];
let pollErrors = 0;
let lastChatTimestamp = 0;
let playerNickname = null;
let chatOpen = false;

// ============================================
// API
// ============================================
async function apiCall(endpoint, method = 'GET', body = null) {
    const options = { method, credentials: 'include', headers: { 'Content-Type': 'application/json' } };
    if (body) options.body = JSON.stringify(body);
    const response = await fetch(endpoint, options);
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Erreur API');
    }
    return await response.json();
}

// ============================================
// SESSION
// ============================================
async function initSession() {
    try {
        const data = await apiCall('/api/session');
        balance = data.balance;
        playerNickname = data.nickname;
        updateBalance();
        updateNicknameDisplay();
    } catch (e) { console.error('Session error:', e); }
}

function updateBalance() {
    document.getElementById('balance').innerHTML = `<span class="sat-icon">&#8383;</span>${balance.toLocaleString()}`;
}

function updateNicknameDisplay() {
    const el = document.getElementById('nicknameDisplay');
    if (el) el.textContent = playerNickname || '[pseudo]';
}

function showNicknamePrompt() {
    const nick = prompt('Votre pseudo (2-16 car.):', playerNickname || '');
    if (nick !== null && nick.trim().length >= 2) {
        apiCall('/api/session', 'POST', { nickname: nick.trim() }).then(data => {
            playerNickname = data.nickname;
            updateNicknameDisplay();
        }).catch(e => alert(e.message));
    }
}

// ============================================
// TOAST
// ============================================
function showToast(text, type, duration = 2500) {
    const toast = document.getElementById('toast');
    toast.textContent = text;
    toast.className = 'toast ' + type;
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => toast.classList.remove('show'), duration);
}

// ============================================
// LOBBY
// ============================================
async function loadLobby() {
    try {
        const data = await apiCall('/api/table/list');
        const container = document.getElementById('lobby');
        container.innerHTML = '';
        data.tables.forEach(t => {
            const statusClass = t.status === 'waiting' ? 'status-waiting' : (t.status === 'betting' ? 'status-betting' : 'status-playing');
            const statusLabels = { waiting: 'EN ATTENTE', betting: 'MISES EN COURS', playing: 'EN JEU', dealing: 'DISTRIBUTION', dealer_turn: 'DEALER', finished: 'ROUND FINI', settling: 'PAIEMENT' };
            let dots = '';
            for (let i = 0; i < t.maxPlayers; i++) dots += `<div class="player-dot ${i < t.playerCount ? 'occupied' : 'empty'}"></div>`;
            const card = document.createElement('div');
            card.className = 'table-card';
            card.onclick = () => joinTableView(t.id);
            card.innerHTML = `<h3>${t.name}</h3><div class="table-players">${dots}</div><div class="table-info">${t.playerCount}/${t.maxPlayers} joueurs</div><div class="table-info">Mises: ${t.minBet} - ${t.maxBet} sats</div><div class="table-status ${statusClass}">${statusLabels[t.status] || t.status}</div>`;
            container.appendChild(card);
        });
    } catch (e) { console.error('Lobby error:', e); }
}

// ============================================
// TABLE VIEW
// ============================================
async function joinTableView(tableId) {
    currentTableId = tableId;
    currentBet = 0;
    previousStatus = null;
    chatMessages = [];
    lastChatTimestamp = Date.now() - 5000;
    document.getElementById('lobby').classList.add('hidden');
    document.getElementById('tableView').classList.add('active');
    document.getElementById('chatToggle').style.display = 'flex';
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('backBtn').href = '#';
    document.getElementById('backBtn').textContent = 'LOBBY';
    document.getElementById('backBtn').onclick = (e) => { e.preventDefault(); leaveTable(); };
    addChatSystem('Bienvenue a la table!');
    await pollTable();
    pollInterval = setInterval(pollTable, 1500);
}

function backToLobby() {
    if (pollInterval) clearInterval(pollInterval);
    currentTableId = null;
    lastTableState = null;
    currentBet = 0;
    previousStatus = null;
    pollErrors = 0;
    chatOpen = false;
    document.getElementById('lobby').classList.remove('hidden');
    document.getElementById('tableView').classList.remove('active');
    document.getElementById('chatToggle').style.display = 'none';
    document.getElementById('chatDrawer').classList.remove('open');
    document.getElementById('backBtn').href = '/';
    document.getElementById('backBtn').textContent = 'SOLO';
    document.getElementById('backBtn').onclick = null;
    loadLobby();
}

async function pollTable() {
    if (!currentTableId) return;
    try {
        const chatSince = lastChatTimestamp || (Date.now() - 30000);
        const data = await apiCall(`/api/table/${currentTableId}?chat_since=${chatSince}`);
        lastTableState = data;
        pollErrors = 0;
        document.getElementById('connDot').className = 'conn-dot ok';

        if (data.balance !== undefined) {
            balance = data.balance;
            updateBalance();
        }

        if (data.chatMessages && data.chatMessages.length > 0) {
            data.chatMessages.forEach(msg => {
                const mySeat = data.seats.find(s => s.isMe);
                const mySeatIdx = mySeat ? data.seats.indexOf(mySeat) : -1;
                if (msg.seatIdx !== mySeatIdx) addChatMessage(msg.playerName, msg.message);
                if (msg.timestamp > lastChatTimestamp) lastChatTimestamp = msg.timestamp;
            });
        }

        detectPhaseChange(data);
        previousStatus = data.status;
        renderTable(data);
    } catch (e) {
        pollErrors++;
        if (pollErrors > 3) document.getElementById('connDot').className = 'conn-dot error';
    }
}

function detectPhaseChange(data) {
    if (!previousStatus) return;

    if (previousStatus !== 'finished' && data.status === 'finished') {
        const mySeat = data.seats.find(s => s.isMe);
        if (mySeat && mySeat.netGain !== undefined && mySeat.netGain !== null) {
            const gain = mySeat.netGain;
            if (gain > 0) {
                const hasBJ = mySeat.hands && mySeat.hands.some(h => h.result === 'bj');
                if (hasBJ) {
                    showToast(`BLACKJACK! +${gain}`, 'bj');
                } else {
                    showToast(`+${gain} sats!`, 'win');
                }
                if (typeof confetti !== 'undefined') confetti({ particleCount: hasBJ ? 150 : 80, spread: 60, origin: { y: 0.5 }, colors: ['#ff6b00', '#ffa500', '#ffd700'] });
                if (mySeat.bet) lastBet = mySeat.bet;
            } else if (gain < 0) {
                showToast(`${gain} sats`, 'loss');
            } else {
                showToast('PUSH', 'push');
            }
            if (navigator.vibrate) navigator.vibrate(gain > 0 ? [200, 100, 200] : [80]);
        }
    }

    if (previousStatus === 'betting' && (data.status === 'dealing' || data.status === 'playing')) {
        addChatSystem('Distribution des cartes...');
    }
    if (data.isMyTurn && (!lastTableState || !lastTableState.isMyTurn)) {
        addChatSystem('C\'est votre tour!');
        if (navigator.vibrate) navigator.vibrate(50);
    }
    if (previousStatus !== 'betting' && data.status === 'betting') addChatSystem('Phase de mise ouverte!');
    if (previousStatus === 'finished' && data.status === 'waiting') addChatSystem('Nouveau round!');
}

// ============================================
// RENDER CARD
// ============================================
function renderCardHTML(card) {
    if (card.hidden) return `<div class="card hidden-card"></div>`;
    const isRed = card.suit === '\u2665' || card.suit === '\u2666';
    return `<div class="card"><div class="card-content ${isRed ? 'red' : 'black'}"><div class="corner">${card.value}${card.suit}</div><div class="center">${card.suit}</div></div></div>`;
}

// ============================================
// RENDER TABLE
// ============================================
function renderTable(data) {
    const phaseLabels = { waiting: 'EN ATTENTE', betting: 'PLACEZ VOS MISES', dealing: 'DISTRIBUTION...', playing: 'EN JEU', dealer_turn: 'TOUR DU DEALER', finished: 'ROUND TERMINE', settling: 'PAIEMENT...' };
    document.getElementById('phaseLabel').textContent = phaseLabels[data.status] || data.status;

    // Dealer
    const dc = document.getElementById('dealerCards');
    dc.innerHTML = (data.dealerCards || []).map(c => renderCardHTML(c)).join('');

    const ds = document.getElementById('dealerScore');
    if (data.dealerScore !== null && data.dealerCards && data.dealerCards.length > 0) {
        ds.innerHTML = `<span class="dealer-score-badge ${data.dealerScore > 21 ? 'bust' : ''}">${data.dealerScore}</span>`;
    } else ds.innerHTML = '';

    // Timer
    const timerRow = document.getElementById('timerRow');
    if (data.timerSeconds !== null && data.timerSeconds !== undefined) {
        timerRow.style.display = 'flex';
        const maxTime = data.status === 'betting' ? 20 : 30;
        const pct = Math.max(0, (data.timerSeconds / maxTime) * 100);
        const fill = document.getElementById('timerFill');
        fill.style.width = pct + '%';
        fill.className = 'timer-fill-mini' + (pct < 25 ? ' low' : '');
        document.getElementById('timerText').textContent = data.timerSeconds + 's';
    } else {
        timerRow.style.display = 'none';
    }

    // Seats
    const grid = document.getElementById('seatsGrid');
    grid.innerHTML = '';

    data.seats.forEach((seat, idx) => {
        const div = document.createElement('div');

        if (seat.empty) {
            div.className = 'seat empty-seat';
            div.onclick = () => joinSeat(idx);
            div.innerHTML = `<div class="seat-name">SIEGE ${idx + 1}</div><div style="font-size:20px;color:rgba(255,107,0,0.5);margin:6px 0;">+</div>`;
        } else {
            const isActive = data.status === 'playing' && data.currentSeatIdx === idx;
            const cls = ['seat'];
            if (seat.isMe) cls.push('is-me');
            if (isActive) cls.push('active-turn');
            div.className = cls.join(' ');

            let handsHTML = '';
            (seat.hands || []).forEach((hand, hIdx) => {
                const cards = hand.cards.map(c => renderCardHTML(c)).join('');
                const isBust = hand.score > 21;
                let rHTML = '';
                if (hand.result) {
                    const rClass = { win:'result-win', loss:'result-loss', bust:'result-bust', push:'result-push', bj:'result-bj', surrender:'result-surrender' }[hand.result] || '';
                    const rLabel = { win:'WIN', loss:'LOSS', bust:'BUST', push:'PUSH', bj:'BJ!', surrender:'ABANDON' }[hand.result] || hand.result;
                    rHTML = `<div class="seat-result ${rClass}">${rLabel}</div>`;
                }
                const hLabel = seat.hands.length > 1 ? `<div style="font-size:8px;color:#666;margin-top:2px;">M${hIdx+1}</div>` : '';
                handsHTML += `${hLabel}<div class="seat-cards">${cards}</div><span class="mini-score ${isBust?'bust':''}">${hand.score}</span>${rHTML}`;
            });

            let gainHTML = '';
            if (data.status === 'finished' && seat.netGain !== undefined && seat.netGain !== null) {
                const c = seat.netGain > 0 ? '#00ff00' : (seat.netGain < 0 ? '#ff4444' : '#ffa500');
                const s = seat.netGain >= 0 ? '+' : '';
                gainHTML = `<div class="seat-gain" style="color:${c}">${s}${seat.netGain}</div>`;
            }

            const nameDisplay = seat.isMe ? 'VOUS' : seat.playerName;
            const betDisplay = seat.bet > 0 ? `<div class="seat-bet-badge">${seat.bet} sats</div>` : '';

            div.innerHTML = `<div class="seat-name">${nameDisplay}</div>${betDisplay}${handsHTML}${gainHTML}${isActive ? '<div style="color:#ffa500;font-size:8px;animation:blink 1s infinite;">EN JEU</div>' : ''}`;
        }
        grid.appendChild(div);
    });

    renderControls(data);
}

// ============================================
// CONTROLS
// ============================================
function renderControls(data) {
    const c = document.getElementById('controls');

    if (data.mySeat < 0) {
        c.innerHTML = '<span class="info-text">Choisissez un siege pour jouer</span>';
        return;
    }

    // Can bet
    if (data.canBet) {
        const min = data.minBet, max = data.maxBet;
        let rebet = '';
        if (lastBet > 0 && lastBet >= min && lastBet <= max && balance >= lastBet)
            rebet = `<button class="act-btn act-rebet" onclick="quickRebet(${lastBet})">RE-BET ${lastBet}</button>`;

        c.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;width:100%;">
                <div class="bet-amount" id="betDisplay">${currentBet || '-'}</div>
                <div class="chips-row">
                    <div class="chip c100 ${currentBet+100>max||balance<100?'disabled':''}" onclick="addBet(100,${max})">100</div>
                    <div class="chip c500 ${currentBet+500>max||balance<500?'disabled':''}" onclick="addBet(500,${max})">500</div>
                    <div class="chip c1k ${currentBet+1000>max||balance<1000?'disabled':''}" onclick="addBet(1000,${max})">1K</div>
                    <div class="chip c5k ${currentBet+5000>max||balance<5000?'disabled':''}" onclick="addBet(5000,${max})">5K</div>
                </div>
                <div style="display:flex;gap:6px;">
                    <button class="act-btn act-bet" onclick="placeBet()" ${currentBet<min?'disabled':''}>MISER</button>
                    <button class="act-btn act-surrender" onclick="currentBet=0;renderControls(lastTableState)">RESET</button>
                    ${rebet}
                </div>
            </div>`;
        return;
    }

    // My turn
    if (data.isMyTurn) {
        c.innerHTML = `
            <button class="act-btn act-hit" onclick="doAction('hit')" ${!data.canHit?'disabled':''}>CARTE</button>
            <button class="act-btn act-stand" onclick="doAction('stand')" ${!data.canStand?'disabled':''}>RESTER</button>
            <button class="act-btn act-double" onclick="doAction('double')" ${!data.canDouble?'disabled':''}>x2</button>
            <button class="act-btn act-split" onclick="doAction('split')" ${!data.canSplit?'disabled':''}>SPLIT</button>
            ${data.canInsurance ? '<button class="act-btn act-insurance" onclick="doInsurance(true)">ASSURANCE</button><button class="act-btn act-surrender" onclick="doInsurance(false)">NON</button>' : ''}
            ${data.canSurrender && !data.canInsurance ? '<button class="act-btn act-surrender" onclick="doAction(\'surrender\')">ABANDON</button>' : ''}
        `;
        return;
    }

    if (data.status === 'playing') {
        const active = data.seats[data.currentSeatIdx];
        const name = active && !active.empty ? active.playerName : '...';
        c.innerHTML = `<span class="phase-highlight">TOUR DE ${name}</span>`;
        return;
    }

    if (data.status === 'finished') {
        let rebet = '';
        if (lastBet > 0 && balance >= lastBet) rebet = `<button class="act-btn act-rebet" onclick="quickRebet(${lastBet})">RE-BET ${lastBet}</button>`;
        c.innerHTML = `<span class="phase-highlight">ROUND TERMINE</span>${rebet}`;
        return;
    }

    if (data.status === 'betting') {
        c.innerHTML = '<span class="info-text">Mise placee! En attente...</span>';
        return;
    }

    if (['dealing', 'dealer_turn', 'settling'].includes(data.status)) {
        c.innerHTML = `<span class="info-text">${data.status === 'dealer_turn' ? 'Le dealer joue...' : 'En cours...'}</span>`;
        return;
    }

    c.innerHTML = '<span class="info-text">En attente...</span>';
}

// ============================================
// CHAT
// ============================================
function toggleChat() {
    chatOpen = !chatOpen;
    document.getElementById('chatDrawer').classList.toggle('open', chatOpen);
}

function addChatMessage(name, text) {
    chatMessages.push({ name, text });
    if (chatMessages.length > 30) chatMessages.shift();
    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-msg';
    div.innerHTML = `<span class="name">${name}:</span> ${text}`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function addChatSystem(text) {
    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-msg';
    div.innerHTML = `<span class="system">${text}</span>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

async function sendChat(msg) {
    if (!currentTableId) return;
    try { await apiCall(`/api/table/${currentTableId}/chat`, 'POST', { message: msg }); } catch(e) {}
    addChatMessage('Vous', msg);
}

// ============================================
// ACTIONS
// ============================================
function addBet(amount, maxBet) {
    if (currentBet + amount > maxBet || balance < amount) return;
    currentBet += amount;
    if (lastTableState) renderControls(lastTableState);
}

async function quickRebet(amount) {
    currentBet = amount;
    await placeBet();
}

async function placeBet() {
    if (!currentTableId || currentBet <= 0) return;
    try {
        const data = await apiCall(`/api/table/${currentTableId}/bet`, 'POST', { amount: currentBet });
        balance = data.balance;
        updateBalance();
        lastBet = currentBet;
        currentBet = 0;
        addChatSystem(`Mise de ${lastBet} sats placee!`);
        await pollTable();
    } catch (e) { alert(e.message); }
}

async function joinSeat(seatIdx) {
    if (!currentTableId) return;
    try {
        await apiCall(`/api/table/${currentTableId}/join`, 'POST', { seatIdx });
        addChatSystem('Vous avez rejoint la table!');
        await pollTable();
    } catch (e) { alert(e.message); }
}

async function doAction(action) {
    if (!currentTableId) return;
    try {
        const data = await apiCall(`/api/table/${currentTableId}/action`, 'POST', { action });
        lastTableState = data;
        if (data.status === 'finished' && previousStatus !== 'finished') {
            detectPhaseChange(data);
            previousStatus = data.status;
        }
        renderTable(data);
    } catch (e) { alert(e.message); }
}

async function doInsurance(accept) {
    if (!currentTableId) return;
    try {
        const data = await apiCall(`/api/table/${currentTableId}/action`, 'POST', { action: 'insurance', accept });
        lastTableState = data;
        if (data.status === 'finished' && previousStatus !== 'finished') {
            detectPhaseChange(data);
            previousStatus = data.status;
        }
        renderTable(data);
    } catch (e) { alert(e.message); }
}

async function leaveTable() {
    if (!currentTableId) { backToLobby(); return; }
    try { await apiCall(`/api/table/${currentTableId}/leave`, 'POST', {}); } catch(e) {}
    backToLobby();
}

async function sendTip(seatIdx, playerName) {
    const amount = prompt(`Pourboire a ${playerName} (10-1000 sats):`, '100');
    if (!amount) return;
    const tipAmount = parseInt(amount);
    if (!tipAmount || tipAmount < 10 || tipAmount > 1000 || tipAmount > balance) { alert('Montant invalide'); return; }
    try {
        const data = await apiCall(`/api/table/${currentTableId}/tip`, 'POST', { seatIdx, amount: tipAmount });
        balance = data.balance;
        updateBalance();
        addChatSystem(`Tip ${tipAmount} sats a ${playerName}!`);
    } catch (e) { alert(e.message); }
}

// ============================================
// INIT
// ============================================
window.onload = async () => {
    await initSession();
    await loadLobby();
};
</script>
</body>
</html>
